name: Tests & Benchmarks

on: [push]

env:
  SMALLTALK_IMAGE: Squeak64-Trunk
jobs:
  #build:
  #  runs-on: ubuntu-latest
  #  steps:
  #    - uses: actions/checkout@v2
  #    - id: smalltalkci
  #      uses: hpi-swa/setup-smalltalkCI@v1
  #      with:
  #        smalltalk-image: ${{ env.SMALLTALK_IMAGE }}
  #    - name: Run tests
  #      run: smalltalkci -s ${{ steps.smalltalkci.outputs.smalltalk-image }} tests.smalltalk.ston
  #      timeout-minutes: 15
  #      env:
  #        # for uploading coverage reports
  #        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  benchmarks:
      runs-on: ubuntu-latest
      #needs: build
      steps:
      - uses: actions/checkout@v2
      - id: smalltalkci
        uses: hpi-swa/setup-smalltalkCI@v1
        with:
          smalltalk-image: ${{ env.SMALLTALK_IMAGE }}
      - name: Run benchmarks
        run: smalltalkci -s ${{ steps.smalltalkci.outputs.smalltalk-image }} benchmarks.smalltalk.ston
        timeout-minutes: 15
        env:
          TDB_BENCHMARK_RESULTS_PATH: ${{ runner.temp }}/benchmark-data.json
      - name: Download previous benchmark data
        uses: actions/cache@v1
        with:
          path: ./cache
          key: ${{ runner.os }}-benchmark
      - name: Store benchmark data
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: customSmallerIsBetter
          output-file-path: ${{ runner.temp }}/benchmark-data.json
          external-data-json-path: ./cache/benchmark-data.json
          auto-push: true
          gh-pages-branch: gh-pages-benchmarks
          comment-always: true
          fail-on-alert: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
