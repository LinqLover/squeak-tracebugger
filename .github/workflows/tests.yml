name: Tests & Benchmarks

on: [push]

env:
  SMALLTALK_IMAGE: Squeak64-Trunk
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Fix broken apt list
        run: sudo perl -p -i -e 's#16\.04/prod xenial#18.04/prod bionic#' /etc/apt/sources.list.d/microsoft-prod.list{,.save}
      - id: smalltalkci
        uses: hpi-swa/setup-smalltalkCI@v1
        with:
          smalltalk-image: ${{ env.SMALLTALK_IMAGE }}
      - id: download-vm
        name: Download latest VM
        run: scripts/download_vm.sh
      - name: Run tests
        run: smalltalkci -s "${{ steps.smalltalkci.outputs.smalltalk-image }}" --vm "${{ steps.download-vm.outputs.vm-path }}" tests.smalltalk.ston
        timeout-minutes: 15
        env:
          # for uploading coverage reports
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  benchmarks:
      runs-on: ubuntu-latest
      needs: build
      steps:
      - uses: actions/checkout@v2
      - id: smalltalkci
        uses: hpi-swa/setup-smalltalkCI@v1
        with:
          smalltalk-image: ${{ env.SMALLTALK_IMAGE }}
      - id: download-vm
        name: Download latest VM
        run: scripts/download_vm.sh
      - name: Run benchmarks
        run: smalltalkci -s ${{ steps.smalltalkci.outputs.smalltalk-image }} --vm "${{ steps.download-vm.outputs.vm-path }}" benchmarks.smalltalk.ston
        timeout-minutes: 15
        env:
          TDB_BENCHMARK_RESULTS_PATH: ${{ runner.temp }}/benchmark-data.json
      - name: Download previous benchmark data
        uses: actions/cache@v1
        with:
          path: ./cache
          key: ${{ runner.os }}-benchmark
      - name: Store benchmark data
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: customSmallerIsBetter
          output-file-path: ${{ runner.temp }}/benchmark-data.json
          auto-push: true
          gh-pages-branch: gh-pages-benchmarks-2
          comment-always: false
          fail-on-alert: false
          alert-threshold: "150%"
          github-token: ${{ secrets.GITHUB_TOKEN }}
